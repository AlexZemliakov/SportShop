<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель | SportShop</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* Обновленные стили для админ-панели */
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background-color: #1e1e1e;
      color: #ffffff;
    }

    .admin-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #333333;
    }

    .admin-header h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #2ecc71;
    }

    .admin-header nav a {
      color: #3498db;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .admin-header nav a:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }

    /* Стили вкладок */
    .admin-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #333333;
    }

    .admin-tab {
      padding: 12px 24px;
      cursor: pointer;
      background-color: #34495e;
      color: #ecf0f1;
      margin-right: 8px;
      border-radius: 6px 6px 0 0;
      transition: all 0.3s ease;
      font-weight: 500;
      border: 1px solid transparent;
    }

    .admin-tab.active {
      background-color: #2ecc71;
      color: #fff;
      border-color: #27ae60;
      box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3);
    }

    .admin-tab:hover:not(.active) {
      background-color: #3d566e;
      color: #fff;
    }

    /* Стили контента вкладок */
    .tab-content {
      display: none;
      padding: 20px;
      background-color: #2c3e50;
      border-radius: 0 6px 6px 6px;
      margin-top: -1px;
    }

    .tab-content.active {
      display: block;
    }

    /* Формы */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #ecf0f1;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      background-color: #34495e;
      border: 1px solid #3d566e;
      border-radius: 4px;
      color: #ecf0f1;
      font-size: 1rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    /* Кнопки */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 1rem;
    }

    .btn-primary {
      background-color: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c0392b;
    }

    .btn-edit {
      background-color: #f39c12;
      color: white;
      margin-right: 0.5rem;
    }

    .btn-edit:hover {
      background-color: #d35400;
    }

    /* Таблицы */
    .table-container {
      overflow-x: auto;
      margin-top: 2rem;
      background-color: #2c3e50;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #3d566e;
    }

    th {
      background-color: #34495e;
      font-weight: 600;
      color: #ecf0f1;
    }

    tr:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }

    /* Сообщения */
    .empty, .error {
      padding: 1rem;
      text-align: center;
      color: #bdc3c7;
      background-color: #34495e;
      border-radius: 4px;
      margin: 1rem 0;
    }

    .error {
      color: #e74c3c;
    }
  </style>
</head>
<body>
<div class="admin-container">
  <header class="admin-header">
    <h1>Админ-панель SportShop</h1>
    <nav>
      <a href="/">На главную</a>
    </nav>
  </header>

  <div class="admin-tabs">
    <div class="admin-tab active" data-tab="products">Товары</div>
    <div class="admin-tab" data-tab="categories">Категории</div>
  </div>

  <!-- Вкладка товаров -->
  <div id="productsTab" class="tab-content active">
    <div class="add-product-form">
      <h2>Добавить товар</h2>
      <input type="hidden" id="editProductId">
      <div class="form-group">
        <label for="productName">Название товара</label>
        <input type="text" id="productName" placeholder="Введите название товара" required>
      </div>
      <div class="form-group">
        <label for="productDescription">Описание</label>
        <textarea id="productDescription" placeholder="Введите описание товара" required></textarea>
      </div>
      <div class="form-group">
        <label for="productPrice">Цена</label>
        <input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0" required>
      </div>
      <div class="form-group">
        <label for="productStock">Количество</label>
        <input type="number" id="productStock" placeholder="0" min="0" required>
      </div>
      <div class="form-group">
        <label for="productImage">URL изображения</label>
        <input type="text" id="productImage" placeholder="https://example.com/image.jpg">
      </div>
      <div class="form-group">
        <label for="productCategory">Категория</label>
        <select id="productCategory">
          <option value="">Без категории</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" id="saveProductBtn">Добавить товар</button>
        <button class="btn btn-danger" id="cancelEditBtn" style="display: none;">Отмена</button>
      </div>
    </div>

    <div class="product-list">
      <h2>Список товаров</h2>
      <div class="form-group">
        <label for="productCategoryFilter">Фильтр по категории:</label>
        <select id="productCategoryFilter" class="form-control">
          <option value="all">Все категории</option>
        </select>
      </div>
      <div class="table-container">
        <table id="productsTable">
          <thead>
          <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Цена</th>
            <th>Количество</th>
            <th>Категория</th>
            <th>Действия</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Вкладка категорий -->
  <div id="categoriesTab" class="tab-content">
    <div class="add-category-form">
      <h2>Добавить категорию</h2>
      <input type="hidden" id="editCategoryId">
      <div class="form-group">
        <label for="categoryName">Название категории</label>
        <input type="text" id="categoryName" placeholder="Введите название категории" required>
      </div>
      <div class="form-group">
        <label for="categoryDescription">Описание</label>
        <textarea id="categoryDescription" placeholder="Введите описание категории"></textarea>
      </div>
      <div class="form-group">
        <label for="categoryImage">URL изображения</label>
        <input type="text" id="categoryImage" placeholder="https://example.com/category.jpg">
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" id="saveCategoryBtn">Добавить категорию</button>
        <button class="btn btn-danger" id="cancelEditCategoryBtn" style="display: none;">Отмена</button>
      </div>
    </div>

    <div class="category-list">
      <h2>Список категорий</h2>
      <div class="table-container">
        <table id="categoriesTable">
          <thead>
          <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Действия</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // Переключение вкладок
  document.querySelectorAll('.admin-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');

      if (tab.dataset.tab === 'categories') {
        loadCategories();
      } else {
        loadProducts();
      }
    });
  });

  // Загрузка категорий для выпадающих списков
  async function loadCategoriesForSelect() {
    try {
      const response = await fetch('/api/categories');
      const categories = await response.json();

      const productCategorySelect = document.getElementById('productCategory');
      const filterCategorySelect = document.getElementById('productCategoryFilter');

      // Очищаем и добавляем опции
      productCategorySelect.innerHTML = '<option value="">Без категории</option>';
      filterCategorySelect.innerHTML = '<option value="all">Все категории</option>';

      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        productCategorySelect.appendChild(option.cloneNode(true));
        filterCategorySelect.appendChild(option);
      });
    } catch (error) {
      console.error('Ошибка загрузки категорий:', error);
      showError('Не удалось загрузить категории');
    }
  }

  // Загрузка товаров
  async function loadProducts(categoryId = null) {
    try {
      const url = categoryId && categoryId !== 'all'
              ? `/api/categories/${categoryId}/products`
              : '/api/products';

      const response = await fetch(url);
      if (!response.ok) throw new Error('Ошибка сервера');
      const products = await response.json();

      const tbody = document.querySelector('#productsTable tbody');
      tbody.innerHTML = '';

      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Товары отсутствуют</td></tr>';
        return;
      }

      products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.id}</td>
          <td>${product.name}</td>
          <td>${product.description || '-'}</td>
          <td>${product.price.toFixed(2)} ₽</td>
          <td>${product.stock}</td>
          <td>${getCategoryName(product.category_id)}</td>
          <td>
            <button class="btn btn-edit" onclick="editProduct(${product.id})">✏️</button>
            <button class="btn btn-danger" onclick="deleteProduct(${product.id})">🗑️</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error('Ошибка загрузки товаров:', error);
      document.querySelector('#productsTable tbody').innerHTML =
              '<tr><td colspan="7" class="error">Ошибка загрузки товаров</td></tr>';
    }
  }

  // Получение названия категории
  function getCategoryName(categoryId) {
    if (!categoryId) return '-';
    const select = document.getElementById('productCategory');
    const option = select.querySelector(`option[value="${categoryId}"]`);
    return option ? option.textContent : 'Неизвестно';
  }

  // Загрузка категорий
  async function loadCategories() {
    try {
      const response = await fetch('/api/categories');
      if (!response.ok) throw new Error('Ошибка сервера');
      const categories = await response.json();

      const tbody = document.querySelector('#categoriesTable tbody');
      tbody.innerHTML = '';

      if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">Категории отсутствуют</td></tr>';
        return;
      }

      categories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${category.id}</td>
          <td>${category.name}</td>
          <td>${category.description || '-'}</td>
          <td>
            <button class="btn btn-edit" onclick="editCategory(${category.id})">✏️</button>
            <button class="btn btn-danger" onclick="deleteCategory(${category.id})">🗑️</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error('Ошибка загрузки категорий:', error);
      document.querySelector('#categoriesTable tbody').innerHTML =
              '<tr><td colspan="4" class="error">Ошибка загрузки категорий</td></tr>';
    }
  }

  // Фильтрация товаров по категории
  document.getElementById('productCategoryFilter').addEventListener('change', function() {
    loadProducts(this.value);
  });

  // Добавление/редактирование товара
  document.getElementById('saveProductBtn').addEventListener('click', async function() {
    const productId = document.getElementById('editProductId').value;
    const product = {
      name: document.getElementById('productName').value.trim(),
      description: document.getElementById('productDescription').value.trim(),
      price: parseFloat(document.getElementById('productPrice').value),
      stock: parseInt(document.getElementById('productStock').value),
      image_url: document.getElementById('productImage').value.trim() || null,
      category_id: document.getElementById('productCategory').value || null
    };

    // Валидация
    if (!product.name || !product.description || isNaN(product.price) || isNaN(product.stock)) {
      alert('Пожалуйста, заполните все обязательные поля корректно');
      return;
    }

    const url = productId ? `/api/products/${productId}` : '/api/products';
    const method = productId ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(product)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Ошибка сервера');
      }

      resetProductForm();
      loadProducts(document.getElementById('productCategoryFilter').value);
      showSuccess(productId ? 'Товар обновлен' : 'Товар добавлен');
    } catch (error) {
      console.error('Ошибка сохранения товара:', error);
      showError(error.message || 'Ошибка сохранения товара');
    }
  });

  // Отмена редактирования товара
  document.getElementById('cancelEditBtn').addEventListener('click', resetProductForm);

  function resetProductForm() {
    document.getElementById('editProductId').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productDescription').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productStock').value = '';
    document.getElementById('productImage').value = '';
    document.getElementById('productCategory').value = '';
    document.getElementById('saveProductBtn').textContent = 'Добавить товар';
    document.getElementById('cancelEditBtn').style.display = 'none';
  }

  // Редактирование товара
  async function editProduct(id) {
    try {
      const response = await fetch(`/api/products/${id}`);
      if (!response.ok) throw new Error('Ошибка сервера');
      const product = await response.json();

      document.getElementById('editProductId').value = product.id;
      document.getElementById('productName').value = product.name;
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock;
      document.getElementById('productImage').value = product.image_url || '';
      document.getElementById('productCategory').value = product.category_id || '';
      document.getElementById('saveProductBtn').textContent = 'Сохранить изменения';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
    } catch (error) {
      console.error('Ошибка загрузки товара:', error);
      showError('Ошибка загрузки товара');
    }
  }

  // Удаление товара
  async function deleteProduct(id) {
    if (confirm('Вы уверены, что хотите удалить этот товар?')) {
      try {
        const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Ошибка сервера');
        }
        loadProducts(document.getElementById('productCategoryFilter').value);
        showSuccess('Товар удален');
      } catch (error) {
        console.error('Ошибка удаления товара:', error);
        showError(error.message || 'Ошибка удаления товара');
      }
    }
  }

  // Добавление/редактирование категории
  document.getElementById('saveCategoryBtn').addEventListener('click', async function() {
    const categoryId = document.getElementById('editCategoryId').value;
    const category = {
      name: document.getElementById('categoryName').value.trim(),
      description: document.getElementById('categoryDescription').value.trim() || null,
      image_url: document.getElementById('categoryImage').value.trim() || null
    };

    // Валидация
    if (!category.name) {
      alert('Пожалуйста, укажите название категории');
      return;
    }

    const url = categoryId ? `/api/categories/${categoryId}` : '/api/categories';
    const method = categoryId ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(category)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Ошибка сервера');
      }

      resetCategoryForm();
      loadCategories();
      loadCategoriesForSelect();
      showSuccess(categoryId ? 'Категория обновлена' : 'Категория добавлена');
    } catch (error) {
      console.error('Ошибка сохранения категории:', error);
      showError(error.message || 'Ошибка сохранения категории');
    }
  });

  // Отмена редактирования категории
  document.getElementById('cancelEditCategoryBtn').addEventListener('click', resetCategoryForm);

  function resetCategoryForm() {
    document.getElementById('editCategoryId').value = '';
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryDescription').value = '';
    document.getElementById('categoryImage').value = '';
    document.getElementById('saveCategoryBtn').textContent = 'Добавить категорию';
    document.getElementById('cancelEditCategoryBtn').style.display = 'none';
  }

  // Редактирование категории
  async function editCategory(id) {
    try {
      const response = await fetch(`/api/categories/${id}`);
      if (!response.ok) throw new Error('Ошибка сервера');
      const category = await response.json();

      document.getElementById('editCategoryId').value = category.id;
      document.getElementById('categoryName').value = category.name;
      document.getElementById('categoryDescription').value = category.description || '';
      document.getElementById('categoryImage').value = category.image_url || '';
      document.getElementById('saveCategoryBtn').textContent = 'Сохранить изменения';
      document.getElementById('cancelEditCategoryBtn').style.display = 'inline-block';
    } catch (error) {
      console.error('Ошибка загрузки категории:', error);
      showError('Ошибка загрузки категории');
    }
  }

  // Удаление категории
  async function deleteCategory(id) {
    if (confirm('Вы уверены, что хотите удалить эту категорию?')) {
      try {
        const response = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Ошибка сервера');
        }
        loadCategories();
        loadCategoriesForSelect();
        showSuccess('Категория удалена');
      } catch (error) {
        console.error('Ошибка удаления категории:', error);
        showError(error.message || 'Нельзя удалить категорию с товарами');
      }
    }
  }

  // Вспомогательные функции
  function showSuccess(message) {
    alert(message); // Можно заменить на красивый toast-уведомление
  }

  function showError(message) {
    alert(message); // Можно заменить на красивый toast-уведомление
  }

  // Инициализация
  document.addEventListener('DOMContentLoaded', function() {
    loadCategoriesForSelect();
    loadProducts();
  });
</script>
</body>
</html>